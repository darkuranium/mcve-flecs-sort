#include "config.h"
#include <flecs.h>

#include <assert.h>
#include <stdio.h>

#include "renderer.h"

static ecs_world_t* ecs;

int32_t expectedCount;  // used in `renderer.c` for the printf()
static void initECS(void)
{
    // (to help with debugging)
    ECS_IMPORT(ecs, FlecsMonitor);
    ecs_singleton_set(ecs, EcsRest, {0});

    ECS_IMPORT(ecs, Renderer);

    // we need both prefabs to reproduce the bug; just one isn't enough
    ECS_PREFAB(ecs, AWall);
    ecs_set(ecs, AWall, Sprite, { "Wall" });

    ECS_PREFAB(ecs, AGold);
    ecs_set(ecs, AGold, Sprite, { "Gold" });

    {
#define ADD_BUILDING(x, y, Archetype) \
        (++expectedCount, ecs_set(ecs, ecs_new_w_pair(ecs, EcsIsA, (Archetype)), Position, {(x), (y)}))

        //printf("%u,%u => %u\n", (unsigned)wHead, (unsigned)wTail, (unsigned)(wHead + wTail) / 2);

        // the bug seems to depend on y for AGold *not* starting at 0
        for(size_t y = 23; y < 25; y++)
            for(size_t x = 0; x < 2; x++)
                ADD_BUILDING(x, y, AGold);

        for(size_t i = 0; i < 10; i++)
        {
            ADD_BUILDING(25, i, AWall);
            ADD_BUILDING(i, 25, AWall);
        }
    }

    fflush(stderr); // for any FLECS errors, to print them before anything else
}

int main(int argc, char** argv)
{
    ecs = ecs_init_w_args(argc, argv);
    assert(ecs);
#if MCVE_MULTITHREADED
    ecs_set_threads(ecs, 8);
#endif

    initECS();

#if MCVE_RUN_FOREVER
    for(;;)
#endif
        ecs_progress(ecs, 0.0f);

    bool ok = !ecs_fini(ecs);
    assert(ok);

    return 0;
}
