#include "config.h"
#include <flecs.h>

#include <string.h>
#include <stdatomic.h>
#include <assert.h>
#include <stdio.h>

#include "renderer.h"

static ecs_world_t* ecs;

static void initECS(void)
{
    // (to help with debugging)
    ECS_IMPORT(ecs, FlecsMonitor);
    ecs_singleton_set(ecs, EcsRest, {0});

    ECS_IMPORT(ecs, Renderer);

    ECS_PREFAB(ecs, AWall);
    ecs_set(ecs, AWall, Sprite, { "Wall" });

    ECS_PREFAB(ecs, AGold);
    ecs_set(ecs, AGold, Sprite, { "Gold" });

    static const size_t MapSize = 48;

    // (this section is mostly unchanged, to help trigger the bug; it just creates some walls and a 2x2 pile of gold in the middle)
    {
        ecs_entity_t* buildings = malloc(MapSize * MapSize * sizeof(*buildings));
        memset(buildings, 0, MapSize * MapSize * sizeof(*buildings));

        // (simply ensures a building doesn't get added twice to the same tile)
#define ADD_BUILDING(x, y, Archetype)\
        do { \
            if(!buildings[(y) * MapSize + (x)]) \
                buildings[(y) * MapSize + (x)] = ecs_set(ecs, ecs_new_w_pair(ecs, EcsIsA, (Archetype)), Position, {(x), (y)}); \
        } while(0)

        // middle of the map is a simple test fort
        size_t wHead = MapSize * 5 / 12;
        size_t wTail = (MapSize * 7 + 11) / 12 - 1;

        // gold at center of fort
        for(size_t y = (wHead + wTail) / 2; y <= (wHead + wTail + 1) / 2; y++)
            for(size_t x = (wHead + wTail) / 2; x <= (wHead + wTail + 1) / 2; x++)
                ADD_BUILDING(x, y, AGold);
        // stone walls around the fort
        for(size_t i = wHead; i <= wTail; i++)
        {
            ADD_BUILDING(wHead, i, AWall);
            ADD_BUILDING(wTail, i, AWall);
            ADD_BUILDING(i, wHead, AWall);
            if(!((wHead + wTail) / 2 <= i && i <= (wHead + wTail + 1) / 2))
                ADD_BUILDING(i, wTail, AWall);
        }
        // outer wall
        wHead -= 3;
        wTail += 3;
        for(size_t i = wHead; i <= wTail; i++)
        {
            ADD_BUILDING(wHead, i, AWall);
            ADD_BUILDING(wTail, i, AWall);
            ADD_BUILDING(i, wHead, AWall);
            if(!((wHead + wTail) / 2 <= i && i <= (wHead + wTail + 1) / 2))
                ADD_BUILDING(i, wTail, AWall);
        }

        free(buildings);
    }

    fflush(stderr); // for any FLECS errors, to print them before anything else
}

int main(int argc, char** argv)
{
    ecs = ecs_init_w_args(argc, argv);
    assert(ecs);
#if MCVE_MULTITHREADED
    ecs_set_threads(ecs, 8);
#endif

    initECS();

#if MCVE_RUN_FOREVER
    for(;;)
#endif
        ecs_progress(ecs, 0.0f);

    bool ok = !ecs_fini(ecs);
    assert(ok);

    return 0;
}
