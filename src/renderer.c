#define MODULE_RENDERER_IMPL
#include "renderer.h"
#include "config.h"

#include <stdatomic.h>
#include <stdio.h>

// basically ECS_SYSTEM_DEFINE(...), but with .order_by & .order_by_component
#define ECS_SYSTEM_DEFINE_ORDER_BY(world, id_, phase, order_by_component_, order_by_, ...) \
{ \
        ecs_system_desc_t desc = {0}; \
        ecs_entity_desc_t edesc = {0}; \
        edesc.id = ecs_id(id_);\
        edesc.name = #id_;\
        edesc.add[0] = ((phase) ? ecs_pair(EcsDependsOn, (phase)) : 0); \
        edesc.add[1] = (phase); \
        desc.entity = ecs_entity_init(world, &edesc);\
        desc.query.filter.expr = #__VA_ARGS__; \
        desc.query.order_by_component = (order_by_component_); \
        desc.query.order_by = (order_by_); \
        desc.callback = id_; \
        ecs_id(id_) = ecs_system_init(world, &desc); \
} \
    ecs_assert(ecs_id(id_) != 0, ECS_INVALID_PARAMETER, NULL);

static atomic_int_least32_t SysRenderSprites_count;

static void SysPreRenderSprites(ecs_iter_t* it)
{
    atomic_store(&SysRenderSprites_count, 0);
}

static ECS_SYSTEM_DECLARE(SysRenderSprites);
static void SysRenderSprites(ecs_iter_t* it)
{
    //const Sprite* s = ecs_field(it, Sprite, 1);
    //const Position* p = ecs_field(it, Position, 2);

    // add up the count, for debugging
    atomic_fetch_add(&SysRenderSprites_count, it->count);
}
static int SysRenderSprites_cmp(ecs_entity_t e1, const void* ptr1, ecs_entity_t e2, const void* ptr2)
{
    Position p1 = *(const Position*)ptr1;
    Position p2 = *(const Position*)ptr2;

    if(p1.y < p2.y) return -1;
    if(p1.y > p2.y) return +1;
    // if `y` is the same, sort `x`
    if(p1.x < p2.x) return -1;
    if(p1.x > p2.x) return +1;
    // if both are the same, sort by entity ID (to make it fully deterministic and avoid flicker)
    if(e1 < e2) return -1;
    if(e1 > e2) return +1;
    // everything matches
    return 0;
}

extern int32_t expectedCount;
static void SysPostRenderSprites(ecs_iter_t* it)
{
    printf("COUNT = %d (expected: %d)\n", atomic_load(&SysRenderSprites_count), expectedCount);
    fflush(stdout);
}

void RendererImport(ecs_world_t* world)
{
    ECS_MODULE(world, Renderer);

    ECS_META_COMPONENT(world, Sprite);
    ECS_META_COMPONENT(world, Position);

    ECS_SYSTEM(world, SysPreRenderSprites, EcsPreUpdate);
#if MCVE_SORT_RENDER
    ECS_SYSTEM_DEFINE_ORDER_BY(world, SysRenderSprites, EcsOnUpdate,
                               ecs_id(Position), SysRenderSprites_cmp,
                               [in] Sprite, [in] Position);
#else
    ECS_SYSTEM_DEFINE_ORDER_BY(world, SysRenderSprites, EcsOnUpdate,
                               0, NULL,
                               [in] Sprite, [in] Position);
#endif
    ECS_SYSTEM(world, SysPostRenderSprites, EcsPostUpdate);
}
